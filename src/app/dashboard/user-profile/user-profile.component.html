<app-header/>

@if(!isLoading){
  <div class="profile-config-container">    

    <!-- Sección de imagen de perfil y nombre -->
    <div class="profile-header">
      <!-- Imagen de perfil con preview -->
      <div class="profile-image-section">
        <div class="current-image" *ngIf="!showPreview">          
          <img [src]="photoUrl || './assets/default-avatar.png'" alt="Profile Image" class="profile-img" (error)="onImageError($event)">
          <div class="image-controls">
            <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" style="display: none;">
            <button type="button" class="change-image-btn" (click)="fileInput.click()">
              <i class="pi pi-camera"></i> Cambiar Imagen
            </button>
          </div>
        </div>
 

      <!-- Preview de la nueva imagen -->
      <div class="image-preview" *ngIf="showPreview">
        <h4>Vista Previa</h4>
        <div class="preview-container">
          <img [src]="previewImageUrl" alt="Preview Image" class="preview-img">
        </div>
        <div class="preview-actions">
          <button type="button" class="confirm-btn" (click)="confirmImageUpload()" [disabled]="isUploadingImage">
            <i class="pi pi-check"></i> 
            {{ isUploadingImage ? 'Subiendo...' : 'Confirmar' }}
          </button>
          <button type="button" class="cancel-btn" (click)="cancelImageUpload()" [disabled]="isUploadingImage">
            <i class="pi pi-times"></i> Cancelar
          </button>
        </div>
      </div>

      <!-- Sección de edición de nombre -->
      <div class="name-section">
        <div class="name-display" *ngIf="!isEditingName">
          <h2>{{userProfile.name }}</h2>
          <button type="button" class="edit-name-btn" (click)="startEditingName()">
            <i class="pi pi-pencil"></i>
          </button>
        </div>
        
        <div class="name-edit" *ngIf="isEditingName">
          <div class="name-input-container">
            <input 
              type="text" 
              [(ngModel)]="editedName" 
              class="name-input"
              placeholder="Ingresa tu nombre"
              maxlength="50"
              (keyup.enter)="saveNameEdit()"
              (keyup.escape)="cancelNameEdit()"
            >
            <div class="name-edit-actions">
              <button type="button" class="save-name-btn" (click)="saveNameEdit()" [disabled]="!editedName.trim()">
                <i class="pi pi-check"></i>
              </button>
              <button type="button" class="cancel-name-btn" (click)="cancelNameEdit()">
                <i class="pi pi-times"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  
    <div class="settings-section">
      <h3>Color favorito</h3>
      <div class="color-palettes">
        <div [style.backgroundColor]="colorFavorite"             
             class="palette-option">
        </div>
      </div>
      <div class="custom-color">
        <label>Color personalizado:</label>
        <input type="color" [(ngModel)]="colorFavorite" (change)="updateCustomTheme()">
      </div>
    </div>
  
    <div class="settings-section">
      <h3>Tipo de moneda</h3>
      <div class="currency-selector">
        <select [(ngModel)]="selectedCurrency" (change)="updateCurrency()">
          <option *ngFor="let currency of currencies" [value]="currency.code">
            {{currency.code}} - {{currency.name}}
          </option>
        </select>
      </div>
    </div>
  
    <div class="settings-section">
      <h3>Gastos Compartidos</h3>
      <div class="sharing-toggle">
        <label class="toggle-switch">
          <input type="checkbox" [(ngModel)]="isSharedExpenseEnabled" (change)="toggleSharedExpense()">
          <span class="slider"></span>
        </label>
        <span class="toggle-label">Activa los gastos compartidos</span>
      </div>

      <div class="sharing-details" *ngIf="isSharedExpenseEnabled">
        <div class="emails-header">
            <h4>Invitar usuarios para compartir gastos</h4>
            <p class="helper-text">Escribe el email de las personas con quienes quieres compartir gastos. Te indicaremos si ya están registrados.</p>
          </div>

        <div class="email-list">
         <div class="email-input-container" *ngFor="let emailState of emailStates; let i = index">
              <!-- Input de email con estado -->
              <div class="email-field">
                <input 
                  type="email" 
                  [(ngModel)]="emailState.email"
                  (ngModelChange)="onEmailChange($event, i)"
                  placeholder="usuario@ejemplo.com"
                  class="email-input"
                  [class.validating]="emailState.isValidating"
                  [class.valid]="emailState.userExists === true"
                  [class.new-user]="emailState.userExists === false"
                  [class.invalid]="emailState.validationMessage.includes('❌')"
                >
                
                <!-- Indicador de carga -->
                <div class="loading-indicator" *ngIf="emailState.isValidating">
                  <i class="pi pi-spin pi-spinner"></i>
                </div>
                
                <!-- Indicador de estado -->
                <div class="status-indicator" *ngIf="!emailState.isValidating && emailState.userExists !== null">
                  <i class="pi pi-check-circle" *ngIf="emailState.userExists === true" style="color: #28a745;"></i>
                  <i class="pi pi-exclamation-triangle" *ngIf="emailState.userExists === false" style="color: #ffc107;"></i>
                </div>
                
                <!-- Botón de enviar invitación -->
                <button 
                  class="send-invitation-btn"
                  *ngIf="emailState.canSendInvitation && !emailState.isValidating"
                  (click)="sendInvitation(i)"
                  [disabled]="emailState.isValidating"
                  title="Enviar invitación">
                  <i class="pi pi-send"></i>
                </button>
                
                <!-- Botón de remover -->
                <button class="remove-email" (click)="removeEmail(i)" [disabled]="emailStates.length === 1">
                  <i class="pi pi-times"></i>
                </button>
              </div>
              
              <!-- Mensaje de validación -->
              <div class="validation-message" *ngIf="emailState.validationMessage">
                <small [innerHTML]="emailState.validationMessage"></small>
              </div>
              
              <!-- Información del usuario encontrado -->
              <div class="user-info" *ngIf="emailState.userExists === true && emailState.userName">
                <div class="user-card">
                  <i class="pi pi-user"></i>
                  <span>{{ emailState.userName }}</span>
                  <small class="user-status">Usuario registrado</small>
                </div>
              </div>
            </div>
        </div>
        <!-- Botón para agregar más emails -->
          <div class="add-email-section">
            <button class="add-email-btn" (click)="addNewEmail()">
              <i class="pi pi-plus"></i> Agregar otro email
            </button>
          </div>
           <!-- Resumen de invitaciones -->
          <div class="invitations-summary" *ngIf="shouldShowSummary">
            <div class="summary-card">
              <h5>Resumen</h5>
              <div class="summary-stats">
                <div class="stat">
                  <span class="count">{{ registeredUsersCount }}</span>
                  <small>Usuarios registrados</small>
                </div>
                <div class="stat">
                  <span class="count">{{ newUsersCount }}</span>
                  <small>Usuarios nuevos</small>
                </div>
                <div class="stat">
                  <span class="count">{{ readyToInviteCount }}</span>
                  <small>Listos para invitar</small>
                </div>
              </div>
            </div>
          </div>
      </div>
    </div>
  
    <div class="save-section">
      <button class="save-button" (click)="saveSettings()">Guardar los cambios</button>
    </div>
  </div>
  </div>

}@else {
  <div class="loading-container">
    <p>Cargando...</p>
  </div>
}